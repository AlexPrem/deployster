steps:

  - label: Test
    command:
      - echo "ARG COVERALLS_REPO_TOKEN" >> ./Dockerfile.test
      - echo "ARG BUILDKITE" >> ./Dockerfile.test
      - echo "ARG BUILDKITE_JOB_ID" >> ./Dockerfile.test
      - echo "ARG BUILDKITE_BRANCH" >> ./Dockerfile.test
      - echo "RUN coveralls" >> ./Dockerfile.test
      - docker build --build-arg COVERALLS_REPO_TOKEN="${COVERALLS_REPO_TOKEN}"
                     --build-arg BUILDKITE="${BUILDKITE}"
                     --build-arg BUILDKITE_JOB_ID="${BUILDKITE_JOB_ID}"
                     --build-arg BUILDKITE_BRANCH="${BUILDKITE_BRANCH}"
                     --file "${DEPLOYSTER_HOME}/Dockerfile.test" .

  - wait

  - label: Build & push Docker images
    command:
      - ./.buildkite/build.sh ${BUILDKITE_COMMIT}
