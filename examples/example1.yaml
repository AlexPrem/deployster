plugs:
  gcloud:
    path: {{ gcloud_path }}
    read_only: false
    resource_types:
      - infolinks/deployster-gcp-compute-regional-ip-address
      - infolinks/deployster-gcp-gke-cluster
      - infolinks/deployster-gcp-project
      - infolinks/deployster-k8s-namespace
      - infolinks/deployster-k8s-rbac-cluster-role
      - infolinks/deployster-k8s-rbac-cluster-role-binding
      - infolinks/deployster-k8s-rbac-role
      - infolinks/deployster-k8s-rbac-role-binding
      - infolinks/deployster-k8s-rbac-service-account

resources:

  project:
    type: infolinks/deployster-gcp-project:{{ deployster_version }}
    config:
      project_id: {{ gcp_project }}
      organization_id: {{ organization_id }}
      billing_account_id: {{ billing_account_id }}

  apps-ip-address:
    type: infolinks/deployster-gcp-compute-regional-ip-address:{{ deployster_version }}
    dependencies:
      project: project
    config:
      name: apps-load-balancer
      region: {{ region }}

  apps-cluster:
    type: infolinks/deployster-gcp-gke-cluster:{{ deployster_version }}
    dependencies:
      project: project
    config:
      zone: {{ zone }}
      name: apps
      description: Applications cluster.
      version: 1.8.2-gke.0
      node_pools:
        # Nodes for the web traffic load balancer
        - name: load-balancer
          min_size: 1
          max_size: 1
          preemptible: true
          tags:
            - apps-load-balancer
          labels:
            role: load-balancer
        # Nodes for edge systems (ad-server, static resources, etc)
        - name: edge
          min_size: 1
          max_size: 1
          preemptible: true
          tags:
            - apps-edge
          labels:
            role: edge
        # Nodes for backoffice systems (insight, central, etc)
        - name: backoffice
          min_size: 1
          max_size: 1
          preemptible: true
          tags:
            - apps-backoffice
          labels:
            role: backoffice

  cluster-admin-role:
    type: infolinks/deployster-k8s-rbac-cluster-role:{{ deployster_version }}
    readonly: true
    dependencies:
      cluster: apps-cluster
    config:
      name: cluster-admin
      rules:
        - apiGroups:
          - '*'
          resources:
          - '*'
          verbs:
          - '*'
        - nonResourceURLs:
          - '*'
          verbs:
          - '*'

  team-cluster-admins-binding:
    type: infolinks/deployster-k8s-rbac-cluster-role-binding:{{ deployster_version }}
    dependencies:
      cluster-role: cluster-admin-role
    config:
      name: team-cluster-admins
      subjects:
        - kind: User
          name: arik@infolinks.com
        - kind: User
          name: jack@infolinks.com

  example-namespace:
    type: infolinks/deployster-k8s-namespace:{{ deployster_version }}
    dependencies:
      cluster: apps-cluster
    config:
      name: example
      metadata:
        annotations:
          arik: kfir

  example-role:
    type: infolinks/deployster-k8s-rbac-role:{{ deployster_version }}
    dependencies:
      namespace: example-namespace
    config:
      name: example
      rules:
        - apiGroups:
          - '*'
          resources:
          - '*'
          verbs:
          - 'get'

  example-service-account:
    type: infolinks/deployster-k8s-rbac-service-account:{{ deployster_version }}
    dependencies:
      namespace: example-namespace
    config:
      name: example

  example-role-binding:
    type: infolinks/deployster-k8s-rbac-role-binding:{{ deployster_version }}
    dependencies:
      role: example-role
    config:
      name: example
      subjects:
        - kind: ServiceAccount
          name: example
          namespace: example
